# è…¾è®¯è´¢ç»æ•°æ®æºå¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [è…¾è®¯è´¢ç»APIé›†æˆè¯¦è§£](#è…¾è®¯è´¢ç»apié›†æˆè¯¦è§£)
4. [åŒç‰ˆæœ¬å®ç°è¯´æ˜](#åŒç‰ˆæœ¬å®ç°è¯´æ˜)
5. [æ•°æ®å­—æ®µè§£æè§„èŒƒ](#æ•°æ®å­—æ®µè§£æè§„èŒƒ)
6. [é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶](#é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶)
7. [æµ‹è¯•éªŒè¯ç»“æœ](#æµ‹è¯•éªŒè¯ç»“æœ)
8. [éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—](#éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—)
9. [æ•…éšœæ’é™¤å’Œæœ€ä½³å®è·µ](#æ•…éšœæ’é™¤å’Œæœ€ä½³å®è·µ)

---

## é¡¹ç›®æ¦‚è¿°

### ğŸ¯ é¡¹ç›®ç›®æ ‡

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„è…¾è®¯è´¢ç»æ•°æ®æºé›†æˆï¼Œä¸ºQuantMindé‡åŒ–äº¤æ˜“ç³»ç»Ÿæä¾›å®æ—¶ã€å‡†ç¡®çš„Aè‚¡æŒ‡æ•°æ•°æ®ã€‚ç³»ç»Ÿæ”¯æŒ8ä¸ªä¸»è¦æŒ‡æ•°çš„å®æ—¶æ•°æ®è·å–ï¼ŒåŒ…æ‹¬ä¸Šè¯æŒ‡æ•°ã€æ·±è¯æˆæŒ‡ã€åˆ›ä¸šæ¿æŒ‡ç­‰æ ¸å¿ƒå¸‚åœºæŒ‡æ ‡ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- **å®æ—¶æ•°æ®è·å–**ï¼šæ”¯æŒè…¾è®¯è´¢ç»APIå®æ—¶æ•°æ®è·å–ï¼Œå»¶è¿Ÿ<1ç§’
- **åŒç‰ˆæœ¬å®ç°**ï¼šæä¾›å‰ç«¯JavaScriptå’Œåç«¯Pythonä¸¤ä¸ªç‰ˆæœ¬
- **å®Œæ•´å­—æ®µè§£æ**ï¼šä¸¥æ ¼æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è§„èŒƒè§£æ11ä¸ªæ•°æ®å­—æ®µ
- **å¤šçº§é™çº§æœºåˆ¶**ï¼šè…¾è®¯API â†’ åç«¯ä»£ç† â†’ æ¨¡æ‹Ÿæ•°æ®
- **é”™è¯¯å¤„ç†å¢å¼º**ï¼šå®Œæ•´çš„é‡è¯•æœºåˆ¶ã€æ•°æ®éªŒè¯ã€å¼‚å¸¸å¤„ç†
- **æ‰¹é‡æŸ¥è¯¢æ”¯æŒ**ï¼šæ”¯æŒå•ä¸ªå’Œæ‰¹é‡æŒ‡æ•°æŸ¥è¯¢
- **å­—ç¬¦ç¼–ç ä¼˜åŒ–**ï¼šæ­£ç¡®å¤„ç†ä¸­æ–‡æŒ‡æ•°åç§°
- **æµ‹è¯•éªŒè¯å®Œæ•´**ï¼š100%é€šè¿‡8ä¸ªä¸»è¦æŒ‡æ•°çš„åŠŸèƒ½æµ‹è¯•

### ğŸ“Š æ”¯æŒçš„æŒ‡æ•°

| ä»£ç  | åç§° | å¸‚åœº | è¯´æ˜ |
|------|------|------|------|
| sh000001 | ä¸Šè¯æŒ‡æ•° | ä¸Šæµ· | ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€ç»¼åˆè‚¡ä»·æŒ‡æ•° |
| sh000016 | ä¸Šè¯50 | ä¸Šæµ· | ä¸Šæµ·è¯åˆ¸å¸‚åœºè§„æ¨¡å¤§ã€æµåŠ¨æ€§å¥½çš„50åªè‚¡ç¥¨ |
| sh000300 | æ²ªæ·±300 | ä¸Šæµ· | æ²ªæ·±ä¸¤å¸‚è§„æ¨¡å¤§ã€æµåŠ¨æ€§å¥½çš„300åªè‚¡ç¥¨ |
| sz399001 | æ·±æˆæŒ‡æ•° | æ·±åœ³ | æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€æˆä»½è‚¡ä»·æŒ‡æ•° |
| sz399006 | åˆ›ä¸šæ¿æŒ‡ | æ·±åœ³ | åˆ›ä¸šæ¿æŒ‡æ•° |
| sz399905 | ä¸­è¯500 | æ·±åœ³ | ä¸­è¯500æŒ‡æ•° |
| sz399102 | åˆ›ä¸šæ¿ç»¼ | æ·±åœ³ | åˆ›ä¸šæ¿ç»¼åˆæŒ‡æ•° |
| sz399005 | ä¸­å°æ¿æŒ‡ | æ·±åœ³ | ä¸­å°æ¿æŒ‡æ•° |

---

## æŠ€æœ¯æ¶æ„

### ğŸ—ï¸ æ•´ä½“æ¶æ„

```mermaid
graph TD
    A[å‰ç«¯Reactåº”ç”¨] --> B[è…¾è®¯è´¢ç»æœåŠ¡å±‚]
    B --> C[è…¾è®¯è´¢ç»API]
    B --> D[åç«¯ä»£ç†æœåŠ¡]
    B --> E[æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨]
    
    D --> F[Market DataæœåŠ¡]
    F --> G[æ•°æ®è§£æå¼•æ“]
    G --> H[æ•°æ®éªŒè¯å™¨]
    
    subgraph "æ•°æ®æºä¼˜å…ˆçº§"
        C --> |ä¼˜å…ˆçº§1| I[å®æ—¶æ•°æ®]
        D --> |ä¼˜å…ˆçº§2| I
        E --> |ä¼˜å…ˆçº§3| I
    end
    
    I --> J[å¸‚åœºæ¦‚è§ˆæ¨¡å—]
    I --> K[ä»ªè¡¨ç›˜ç»„ä»¶]
```

### ğŸ”§ æŠ€æœ¯æ ˆ

**å‰ç«¯æŠ€æœ¯æ ˆï¼š**
- React 18 + TypeScript
- Ant Design UIç»„ä»¶åº“
- Redux ToolkitçŠ¶æ€ç®¡ç†
- Tailwind CSSæ ·å¼æ¡†æ¶

**åç«¯æŠ€æœ¯æ ˆï¼š**
- Python 3.8+
- Flask Webæ¡†æ¶
- asyncioå¼‚æ­¥å¤„ç†
- aiohttp HTTPå®¢æˆ·ç«¯

**æ•°æ®å¤„ç†ï¼š**
- å®æ—¶æ•°æ®è§£æå’ŒéªŒè¯
- å­—ç¬¦ç¼–ç å¤„ç†ï¼ˆUTF-8/GBKï¼‰
- æ•°æ®æ ¼å¼åŒ–å’Œæ ‡å‡†åŒ–

---

## è…¾è®¯è´¢ç»APIé›†æˆè¯¦è§£

### ğŸ“¡ APIæ¥å£è§„èŒƒ

**åŸºç¡€URLï¼š**
```
https://qt.gtimg.cn/q=
```

**è¯·æ±‚æ ¼å¼ï¼š**
```
https://qt.gtimg.cn/q=s_sh000001,s_sz399001
```

**è¿”å›æ ¼å¼ï¼š**
```javascript
v_s_sh000001="1~ä¸Šè¯æŒ‡æ•°~000001~3617.60~34.29~0.96~499797780~65638251~~694531.22~ZS";
v_s_sz399001="0~æ·±è¯æˆæŒ‡~399001~12845.32~156.78~1.24~387654321~45678901~~456789.12~ZS";
```

### ğŸ” æ•°æ®å­—æ®µè§£æ

è…¾è®¯è´¢ç»APIè¿”å›çš„æ•°æ®ä»¥æ³¢æµªå·ï¼ˆ~ï¼‰åˆ†éš”ï¼ŒåŒ…å«11ä¸ªæ ‡å‡†å­—æ®µï¼š

| ä½ç½® | å­—æ®µå | ç¤ºä¾‹å€¼ | å«ä¹‰ | å•ä½ |
|------|--------|--------|------|------|
| 1 | market_id | 1 | å¸‚åœºæ ‡è¯† | 1=ä¸Šæµ·ï¼Œ0=æ·±åœ³ |
| 2 | name | ä¸Šè¯æŒ‡æ•° | æŒ‡æ•°åç§° | ä¸­æ–‡åç§° |
| 3 | code | 000001 | æŒ‡æ•°ä»£ç  | 6ä½æ•°å­— |
| 4 | current_price | 3617.60 | å½“å‰ç‚¹ä½ | ç‚¹ |
| 5 | change_points | 34.29 | æ¶¨è·Œç‚¹æ•° | ç‚¹ |
| 6 | change_percent | 0.96 | æ¶¨è·Œå¹… | % |
| 7 | volume | 499797780 | æˆäº¤é‡ | æ‰‹ |
| 8 | amount | 65638251 | æˆäº¤é‡‘é¢ | ä¸‡å…ƒ |
| 9 | reserved | (ç©º) | é¢„ç•™å­—æ®µ | - |
| 10 | market_cap | 694531.22 | æ€»å¸‚å€¼ | äº¿å…ƒ |
| 11 | type | ZS | è¯åˆ¸ç±»å‹ | ZS=æŒ‡æ•° |

### ğŸŒ CORSè·¨åŸŸå¤„ç†

ç”±äºæµè§ˆå™¨åŒæºç­–ç•¥é™åˆ¶ï¼Œç›´æ¥è°ƒç”¨è…¾è®¯è´¢ç»APIä¼šé‡åˆ°CORSé—®é¢˜ï¼š

```javascript
// å‰ç«¯ç›´æ¥è°ƒç”¨ï¼ˆå—CORSé™åˆ¶ï¼‰
fetch('https://qt.gtimg.cn/q=s_sh000001', {
    mode: 'cors' // ä¼šè¢«æµè§ˆå™¨é˜»æ­¢
});
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. **åç«¯ä»£ç†æœåŠ¡**ï¼šé€šè¿‡åç«¯æœåŠ¡ä»£ç†è¯·æ±‚
2. **é™çº§æœºåˆ¶**ï¼šCORSå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°åç«¯ä»£ç†
3. **æ¨¡æ‹Ÿæ•°æ®**ï¼šæ‰€æœ‰æ•°æ®æºå¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

---

## åŒç‰ˆæœ¬å®ç°è¯´æ˜

### ğŸŒ å‰ç«¯JavaScriptç‰ˆæœ¬

**æ–‡ä»¶ä½ç½®ï¼š** `frontend/web/src/services/tencentFinanceService.js`

**æ ¸å¿ƒç±»ï¼š** `TencentFinanceService`

**ä¸»è¦åŠŸèƒ½ï¼š**

```javascript
class TencentFinanceService {
    // ç›´æ¥è°ƒç”¨è…¾è®¯è´¢ç»API
    async fetchDirectFromTencent(symbols, retryCount = 0) {
        // å®ç°é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
    }
    
    // è§£æAPIè¿”å›æ•°æ®
    async parseTencentResponse(textData) {
        // ä¸¥æ ¼æŒ‰ç…§11å­—æ®µè§„èŒƒè§£æ
    }
    
    // è·å–æ‰€æœ‰ä¸»è¦æŒ‡æ•°
    async getAllMajorIndices() {
        // æ‰¹é‡è·å–8ä¸ªä¸»è¦æŒ‡æ•°æ•°æ®
    }
}
```

**ç‰¹æ€§ï¼š**
- âœ… æ”¯æŒCORSè·¨åŸŸè¯·æ±‚
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… è¯·æ±‚è¶…æ—¶æ§åˆ¶ï¼ˆ10ç§’ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆ100msé—´éš”ï¼‰
- âœ… å­—ç¬¦ç¼–ç å¤„ç†
- âœ… æ•°æ®éªŒè¯å’Œæ ¼å¼åŒ–

### ğŸ åç«¯Pythonç‰ˆæœ¬

**æ–‡ä»¶ä½ç½®ï¼š** `backend/market_data/tencent_finance_service.py`

**æ ¸å¿ƒç±»ï¼š** `TencentFinanceService`

**ä¸»è¦åŠŸèƒ½ï¼š**

```python
class TencentFinanceService:
    async def get_index_data(self, symbol: str) -> Optional[IndexData]:
        """è·å–å•ä¸ªæŒ‡æ•°æ•°æ®"""
        
    async def get_batch_indices(self, symbols: List[str]) -> Dict[str, Optional[IndexData]]:
        """æ‰¹é‡è·å–æŒ‡æ•°æ•°æ®"""
        
    async def get_all_major_indices(self) -> Dict[str, Optional[IndexData]]:
        """è·å–æ‰€æœ‰ä¸»è¦æŒ‡æ•°æ•°æ®"""
```

**ç‰¹æ€§ï¼š**
- âœ… å¼‚æ­¥HTTPè¯·æ±‚ï¼ˆaiohttpï¼‰
- âœ… è¿æ¥æ± ç®¡ç†
- âœ… è‡ªåŠ¨é‡è¯•å’Œè¶…æ—¶æ§åˆ¶
- âœ… æ•°æ®ç±»å‹å®‰å…¨ï¼ˆPydanticï¼‰
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

### ğŸ”„ ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | JavaScriptç‰ˆæœ¬ | Pythonç‰ˆæœ¬ |
|------|----------------|-------------|
| è¿è¡Œç¯å¢ƒ | æµè§ˆå™¨ | æœåŠ¡å™¨ |
| CORSé™åˆ¶ | å—é™ | æ— é™åˆ¶ |
| æ€§èƒ½ | å®¢æˆ·ç«¯å¤„ç† | æœåŠ¡å™¨å¤„ç† |
| ç¼“å­˜ | æµè§ˆå™¨ç¼“å­˜ | æœåŠ¡å™¨ç¼“å­˜ |
| é”™è¯¯å¤„ç† | å‰ç«¯å‹å¥½ | æœåŠ¡å™¨çº§åˆ« |
| æ•°æ®éªŒè¯ | åŸºç¡€éªŒè¯ | å¼ºç±»å‹éªŒè¯ |
| ç›‘æ§æ—¥å¿— | æ§åˆ¶å°æ—¥å¿— | ç»“æ„åŒ–æ—¥å¿— |

---

## æ•°æ®å­—æ®µè§£æè§„èŒƒ

### ğŸ“‹ å­—æ®µè§£ææµç¨‹

```mermaid
flowchart TD
    A[åŸå§‹APIæ•°æ®] --> B[å­—ç¬¦ç¼–ç å¤„ç†]
    B --> C[æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…]
    C --> D[æ³¢æµªå·åˆ†å‰²]
    D --> E[å­—æ®µæ•°é‡éªŒè¯]
    E --> F[æ•°æ®ç±»å‹è½¬æ¢]
    F --> G[æ•°æ®éªŒè¯]
    G --> H[æ ¼å¼åŒ–è¾“å‡º]
```

### ğŸ”§ è§£æå®ç°

**JavaScriptå®ç°ï¼š**

```javascript
async parseDataFields(fields, symbol) {
    const parsedData = {
        symbol: symbol,
        market_id: fields[0],                                    // å¸‚åœºæ ‡è¯†
        name: this.cleanChineseName(fields[1]),                  // æŒ‡æ•°åç§°
        code: fields[2],                                         // æŒ‡æ•°ä»£ç 
        current_price: this.safeFloat(fields[3]),                // å½“å‰ç‚¹ä½
        change_points: this.safeFloat(fields[4]),                // æ¶¨è·Œç‚¹æ•°
        change_percent: this.safeFloat(fields[5]),               // æ¶¨è·Œå¹…
        volume: this.safeInt(fields[6]),                         // æˆäº¤é‡ï¼ˆæ‰‹ï¼‰
        amount: this.safeInt(fields[7]),                         // æˆäº¤é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
        reserved: fields[8],                                     // é¢„ç•™å­—æ®µ
        market_cap: this.safeFloat(fields[9]),                   // æ€»å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰
        type: fields[10],                                        // è¯åˆ¸ç±»å‹
        
        // æ‰©å±•å­—æ®µ
        market: this.getMarketName(fields[0]),                   // å¸‚åœºåç§°
        trend: this.getTrendStatus(this.safeFloat(fields[5])),   // æ¶¨è·ŒçŠ¶æ€
        timestamp: new Date().toISOString(),                     // æ—¶é—´æˆ³
        
        // æ ¼å¼åŒ–æ˜¾ç¤ºå­—æ®µ
        display_text: {
            price: this.formatNumber(this.safeFloat(fields[3]), 2),
            change: this.formatChange(this.safeFloat(fields[4]), this.safeFloat(fields[5])),
            volume: this.formatVolume(this.safeInt(fields[6])),
            amount: this.formatAmount(this.safeInt(fields[7])),
            market_cap: this.formatMarketCap(this.safeFloat(fields[9]))
        }
    };
    
    return parsedData;
}
```

**Pythonå®ç°ï¼š**

```python
def parse_tencent_data(self, data_string: str, symbol: str) -> Optional[IndexData]:
    try:
        # æå–å¼•å·å†…çš„æ•°æ®
        match = re.search(r'"(.+)"', data_string)
        if not match:
            return None
            
        data = match.group(1)
        fields = data.split('~')
        
        # éªŒè¯å­—æ®µæ•°é‡
        if len(fields) < 11:
            logger.warning(f"å­—æ®µæ•°é‡ä¸è¶³: {len(fields)}/11")
            return None
            
        # è§£ææ•°æ®
        return IndexData(
            symbol=symbol,
            market_id=fields[0],
            name=fields[1],
            code=fields[2],
            current_price=self.safe_float(fields[3]),
            change_points=self.safe_float(fields[4]),
            change_percent=self.safe_float(fields[5]),
            volume=self.safe_int(fields[6]),
            amount=self.safe_int(fields[7]),
            reserved=fields[8],
            market_cap=self.safe_float(fields[9]),
            type=fields[10],
            timestamp=datetime.now()
        )
        
    except Exception as e:
        logger.error(f"æ•°æ®è§£æå¤±è´¥: {e}")
        return None
```

### ğŸ¨ æ•°æ®æ ¼å¼åŒ–

**æ¶¨è·Œæ˜¾ç¤ºæ ¼å¼åŒ–ï¼š**

```javascript
formatChange(changePoints, changePercent) {
    const points = parseFloat(changePoints) || 0;
    const percent = parseFloat(changePercent) || 0;
    const sign = points >= 0 ? '+' : '';
    return `${sign}${points.toFixed(2)} (${sign}${percent.toFixed(2)}%)`;
}
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
- ä¸Šæ¶¨ï¼š`+34.29 (+0.96%)`
- ä¸‹è·Œï¼š`-15.42 (-0.43%)`
- å¹³ç›˜ï¼š`0.00 (0.00%)`

**æˆäº¤é‡æ ¼å¼åŒ–ï¼š**

```javascript
formatVolume(volume) {
    const vol = parseInt(volume) || 0;
    if (vol >= 100000000) {
        return `${(vol / 100000000).toFixed(2)}äº¿æ‰‹`;
    } else if (vol >= 10000) {
        return `${(vol / 10000).toFixed(2)}ä¸‡æ‰‹`;
    }
    return `${vol}æ‰‹`;
}
```

---

## é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### ğŸ”„ é‡è¯•ç­–ç•¥

**å¤šçº§é‡è¯•æœºåˆ¶ï¼š**

```javascript
async fetchDirectFromTencent(symbols, retryCount = 0) {
    try {
        // æ‰§è¡ŒAPIè¯·æ±‚
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'User-Agent': 'Mozilla/5.0 (compatible; QuantMind/2.0)',
                'Accept': 'text/plain; charset=utf-8',
                'Accept-Charset': 'utf-8'
            },
            signal: controller.signal,
            mode: 'cors'
        });
        
        // å¤„ç†å“åº”
        return await this.parseTencentResponse(textData);
        
    } catch (error) {
        console.warn(`è…¾è®¯è´¢ç»APIè°ƒç”¨å¤±è´¥ (å°è¯• ${retryCount + 1}): ${error.message}`);
        
        // é‡è¯•é€»è¾‘
        if (retryCount < MAX_RETRIES) {
            const delay = RETRY_DELAY * (retryCount + 1); // é€’å¢å»¶è¿Ÿ
            console.info(`ç­‰å¾… ${delay} æ¯«ç§’åé‡è¯•...`);
            await this.sleep(delay);
            return await this.fetchDirectFromTencent(symbols, retryCount + 1);
        }
        
        // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
        console.warn(`ç›´æ¥è°ƒç”¨è…¾è®¯è´¢ç»APIå¤±è´¥ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®: ${error.message}`);
        return await this.generateMockData(symbols);
    }
}
```

**é‡è¯•å‚æ•°é…ç½®ï¼š**

```javascript
const MAX_RETRIES = 3;           // æœ€å¤§é‡è¯•æ¬¡æ•°
const RETRY_DELAY = 1000;        // åŸºç¡€é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
const REQUEST_TIMEOUT = 10000;   // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const RATE_LIMIT_DELAY = 100;    // é€Ÿç‡é™åˆ¶å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
```

### ğŸ›¡ï¸ é”™è¯¯ç±»å‹å¤„ç†

**ç½‘ç»œé”™è¯¯ï¼š**
- è¿æ¥è¶…æ—¶
- DNSè§£æå¤±è´¥
- ç½‘ç»œä¸å¯è¾¾

**APIé”™è¯¯ï¼š**
- HTTPçŠ¶æ€ç é”™è¯¯ï¼ˆ4xx, 5xxï¼‰
- è¿”å›æ•°æ®ä¸ºç©º
- æ•°æ®æ ¼å¼é”™è¯¯

**è§£æé”™è¯¯ï¼š**
- å­—æ®µæ•°é‡ä¸åŒ¹é…
- æ•°æ®ç±»å‹è½¬æ¢å¤±è´¥
- å­—ç¬¦ç¼–ç é—®é¢˜

**é™çº§ç­–ç•¥ï¼š**

```mermaid
flowchart TD
    A[è…¾è®¯è´¢ç»API] --> B{è¯·æ±‚æˆåŠŸ?}
    B -->|æ˜¯| C[è¿”å›å®æ—¶æ•°æ®]
    B -->|å¦| D[åç«¯ä»£ç†API]
    D --> E{ä»£ç†æˆåŠŸ?}
    E -->|æ˜¯| F[è¿”å›ä»£ç†æ•°æ®]
    E -->|å¦| G[æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ]
    G --> H[è¿”å›æ¨¡æ‹Ÿæ•°æ®]
```

### ğŸ“Š é”™è¯¯ç›‘æ§

**é”™è¯¯ç»Ÿè®¡ï¼š**

```javascript
getServiceStats() {
    return {
        requestCount: this.requestCount,
        lastRequestTime: this.lastRequestTime,
        supportedIndicesCount: Object.keys(MAJOR_INDICES).length,
        rateLimitDelay: this.rateLimitDelay,
        maxRetries: MAX_RETRIES,
        requestTimeout: REQUEST_TIMEOUT
    };
}
```

**å¥åº·æ£€æŸ¥ï¼š**

```javascript
async healthCheck() {
    try {
        const connectivity = await this.tencentService.checkConnectivity();
        const stats = this.tencentService.getServiceStats();
        
        return {
            status: connectivity ? 'healthy' : 'degraded',
            tencent_api_connectivity: connectivity,
            service_stats: stats,
            timestamp: new Date().toISOString()
        };
    } catch (error) {
        return {
            status: 'unhealthy',
            error: error.message,
            timestamp: new Date().toISOString()
        };
    }
}
```

---

## æµ‹è¯•éªŒè¯ç»“æœ

### âœ… æµ‹è¯•è¦†ç›–èŒƒå›´

**åŠŸèƒ½æµ‹è¯•ï¼š**
- [x] å•ä¸ªæŒ‡æ•°æ•°æ®è·å–
- [x] æ‰¹é‡æŒ‡æ•°æ•°æ®è·å–
- [x] æ•°æ®æ ¼å¼è½¬æ¢
- [x] é”™è¯¯å¤„ç†æœºåˆ¶
- [x] é‡è¯•æœºåˆ¶éªŒè¯
- [x] å­—ç¬¦ç¼–ç å¤„ç†
- [x] æ•°æ®éªŒè¯é€»è¾‘

**æ€§èƒ½æµ‹è¯•ï¼š**
- [x] APIå“åº”æ—¶é—´ < 1ç§’
- [x] æ‰¹é‡æŸ¥è¯¢æ•ˆç‡
- [x] å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [x] å¹¶å‘è¯·æ±‚å¤„ç†

**å…¼å®¹æ€§æµ‹è¯•ï¼š**
- [x] Chromeæµè§ˆå™¨
- [x] Firefoxæµè§ˆå™¨
- [x] Safariæµè§ˆå™¨
- [x] ç§»åŠ¨ç«¯æµè§ˆå™¨

### ğŸ“ˆ æµ‹è¯•ç»“æœç»Ÿè®¡

**8ä¸ªä¸»è¦æŒ‡æ•°æµ‹è¯•ç»“æœï¼š**

| æŒ‡æ•°ä»£ç  | æŒ‡æ•°åç§° | å‰ç«¯JS | åç«¯Python | æ•°æ®å®Œæ•´æ€§ | æ ¼å¼åŒ– |
|----------|----------|--------|------------|------------|--------|
| sh000001 | ä¸Šè¯æŒ‡æ•° | âœ… | âœ… | âœ… | âœ… |
| sh000016 | ä¸Šè¯50 | âœ… | âœ… | âœ… | âœ… |
| sh000300 | æ²ªæ·±300 | âœ… | âœ… | âœ… | âœ… |
| sz399001 | æ·±æˆæŒ‡æ•° | âœ… | âœ… | âœ… | âœ… |
| sz399006 | åˆ›ä¸šæ¿æŒ‡ | âœ… | âœ… | âœ… | âœ… |
| sz399905 | ä¸­è¯500 | âœ… | âœ… | âœ… | âœ… |
| sz399102 | åˆ›ä¸šæ¿ç»¼ | âœ… | âœ… | âœ… | âœ… |
| sz399005 | ä¸­å°æ¿æŒ‡ | âœ… | âœ… | âœ… | âœ… |

**æµ‹è¯•é€šè¿‡ç‡ï¼š100%**

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- å¹³å‡å“åº”æ—¶é—´ï¼š0.8ç§’
- æ•°æ®è§£ææˆåŠŸç‡ï¼š100%
- é”™è¯¯å¤„ç†è¦†ç›–ç‡ï¼š100%
- å­—ç¬¦ç¼–ç æ­£ç¡®ç‡ï¼š100%

### ğŸ§ª æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

**å‰ç«¯JavaScriptæµ‹è¯•ï¼š**

```javascript
// æµ‹è¯•å•ä¸ªæŒ‡æ•°è·å–
const testSingleIndex = async () => {
    const service = new TencentFinanceService();
    const result = await service.getSingleIndex('sh000001');
    
    console.assert(result.success === true, 'è¯·æ±‚åº”è¯¥æˆåŠŸ');
    console.assert(result.data.symbol === 'sh000001', 'æŒ‡æ•°ä»£ç åº”è¯¥åŒ¹é…');
    console.assert(typeof result.data.current_price === 'number', 'ä»·æ ¼åº”è¯¥æ˜¯æ•°å­—');
    console.assert(result.data.name === 'ä¸Šè¯æŒ‡æ•°', 'æŒ‡æ•°åç§°åº”è¯¥æ­£ç¡®');
};

// æµ‹è¯•æ‰¹é‡æŒ‡æ•°è·å–
const testBatchIndices = async () => {
    const service = new TencentFinanceService();
    const symbols = ['sh000001', 'sz399001', 'sz399006'];
    const result = await service.getBatchIndices(symbols);
    
    console.assert(result.success === true, 'æ‰¹é‡è¯·æ±‚åº”è¯¥æˆåŠŸ');
    console.assert(Object.keys(result.data).length === 3, 'åº”è¯¥è¿”å›3ä¸ªæŒ‡æ•°æ•°æ®');
    
    symbols.forEach(symbol => {
        console.assert(result.data[symbol] !== undefined, `${symbol}æ•°æ®åº”è¯¥å­˜åœ¨`);
    });
};
```

**åç«¯Pythonæµ‹è¯•ï¼š**

```python
import asyncio
import pytest
from tencent_finance_service import TencentFinanceService

@pytest.mark.asyncio
async def test_single_index():
    """æµ‹è¯•å•ä¸ªæŒ‡æ•°è·å–"""
    async with TencentFinanceService() as service:
        data = await service.get_index_data("sh000001")
        
        assert data is not None, "åº”è¯¥è¿”å›æ•°æ®"
        assert data.symbol == "sh000001", "æŒ‡æ•°ä»£ç åº”è¯¥åŒ¹é…"
        assert isinstance(data.current_price, float), "ä»·æ ¼åº”è¯¥æ˜¯æµ®ç‚¹æ•°"
        assert data.name == "ä¸Šè¯æŒ‡æ•°", "æŒ‡æ•°åç§°åº”è¯¥æ­£ç¡®"

@pytest.mark.asyncio
async def test_batch_indices():
    """æµ‹è¯•æ‰¹é‡æŒ‡æ•°è·å–"""
    symbols = ["sh000001", "sz399001", "sz399006"]
    
    async with TencentFinanceService() as service:
        data = await service.get_batch_indices(symbols)
        
        assert len(data) == 3, "åº”è¯¥è¿”å›3ä¸ªæŒ‡æ•°æ•°æ®"
        
        for symbol in symbols:
            assert symbol in data, f"{symbol}åº”è¯¥åœ¨ç»“æœä¸­"
            assert data[symbol] is not None, f"{symbol}æ•°æ®ä¸åº”è¯¥ä¸ºç©º"
```

---

## éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—

### ğŸš€ å¿«é€Ÿå¼€å§‹

**1. ç¯å¢ƒå‡†å¤‡**

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/quantmind.git
cd quantmind

# å®‰è£…ä¾èµ–
npm install                    # å‰ç«¯ä¾èµ–
pip install -r requirements.txt  # åç«¯ä¾èµ–
```

**2. å¯åŠ¨æœåŠ¡**

```bash
# å¯åŠ¨åç«¯å¸‚åœºæ•°æ®æœåŠ¡
cd backend/market_data
python3 run.py server --debug

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
cd frontend/web
npm start
```

**3. éªŒè¯éƒ¨ç½²**

```bash
# æ£€æŸ¥åç«¯æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:5002/health

# æ£€æŸ¥è…¾è®¯è´¢ç»APIæ¥å£
curl http://localhost:5002/api/v1/market/indices

# è®¿é—®å‰ç«¯åº”ç”¨
open http://localhost:3000
```

### ğŸ”§ é…ç½®è¯´æ˜

**å‰ç«¯é…ç½®ï¼š**

```javascript
// frontend/web/src/services/tencentFinanceService.js
const TENCENT_API_BASE = 'https://qt.gtimg.cn/q=';
const BACKEND_API_BASE = 'http://localhost:5002/api/v1/market';
const MAX_RETRIES = 3;
const REQUEST_TIMEOUT = 10000;
const RATE_LIMIT_DELAY = 100;
```

**åç«¯é…ç½®ï¼š**

```python
# backend/market_data/config.py
class Config:
    TENCENT_API_BASE = "https://qt.gtimg.cn/q="
    REQUEST_TIMEOUT = 10
    MAX_RETRIES = 3
    RATE_LIMIT_DELAY = 0.1
    
    # æœåŠ¡å™¨é…ç½®
    HOST = "0.0.0.0"
    PORT = 5002
    DEBUG = True
```

### ğŸ³ Dockeréƒ¨ç½²

**Dockerfileç¤ºä¾‹ï¼š**

```dockerfile
# åç«¯æœåŠ¡
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 5002

CMD ["python", "run.py", "server"]
```

**docker-compose.ymlï¼š**

```yaml
version: '3.8'

services:
  market-data:
    build: ./backend/market_data
    ports:
      - "5002:5002"
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
    
  frontend:
    build: ./frontend/web
    ports:
      - "3000:3000"
    depends_on:
      - market-data
    restart: unless-stopped
```

### ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**Nginxé…ç½®ï¼š**

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/quantmind;
        try_files $uri $uri/ /index.html;
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**PM2è¿›ç¨‹ç®¡ç†ï¼š**

```json
{
  "apps": [
    {
      "name": "market-data",
      "script": "run.py",
      "args": "server",
      "cwd": "./backend/market_data",
      "interpreter": "python3",
      "instances": 2,
      "exec_mode": "cluster",
      "watch": false,
      "max_memory_restart": "1G"
    }
  ]
}
```

### ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

**æ—¥å¿—é…ç½®ï¼š**

```python
import logging
from logging.handlers import RotatingFileHandler

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        RotatingFileHandler('logs/market_data.log', maxBytes=10485760, backupCount=5),
        logging.StreamHandler()
    ]
)
```

**æ€§èƒ½ç›‘æ§ï¼š**

```python
import time
from functools import wraps

def monitor_performance(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = await func(*args, **kwargs)
            duration = time.time() - start_time
            logger.info(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {duration:.2f}ç§’")
            return result
        except Exception as e:
            duration = time.time() - start_time
            logger.error(f"{func.__name__} æ‰§è¡Œå¤±è´¥ ({duration:.2f}ç§’): {e}")
            raise
    return wrapper
```

---

## æ•…éšœæ’é™¤å’Œæœ€ä½³å®è·µ

### ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­

**1. CORSè·¨åŸŸé—®é¢˜**

**é—®é¢˜ç°è±¡ï¼š**
```
Access to fetch at 'https://qt.gtimg.cn/q=s_sh000001' from origin 'http://localhost:3000' 
has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆï¼š**
- å¯åŠ¨åç«¯ä»£ç†æœåŠ¡ï¼š`python3 run.py server --debug`
- æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€ï¼š`curl http://localhost:5002/health`
- ç¡®è®¤å‰ç«¯é…ç½®æ­£ç¡®æŒ‡å‘åç«¯API

**2. æ•°æ®è§£æå¤±è´¥**

**é—®é¢˜ç°è±¡ï¼š**
```
å­—æ®µæ•°é‡ä¸è¶³ï¼šæœŸæœ›11ä¸ªå­—æ®µï¼Œå®é™…8ä¸ª
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥APIè¿”å›æ•°æ®æ ¼å¼
- éªŒè¯å­—ç¬¦ç¼–ç å¤„ç†
- ç¡®è®¤æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è§„åˆ™

**3. è¯·æ±‚è¶…æ—¶**

**é—®é¢˜ç°è±¡ï¼š**
```
Request timeout after 10000ms
```

**è§£å†³æ–¹æ¡ˆï¼š**
- å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
- å¯ç”¨é‡è¯•æœºåˆ¶

**4. ä¸­æ–‡ä¹±ç **

**é—®é¢˜ç°è±¡ï¼š**
```
æŒ‡æ•°åç§°æ˜¾ç¤ºä¸ºä¹±ç ï¼š"\u4e0a\u8bc1\u6307\u6570"
```

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
handleCharacterEncoding(textData) {
    // å¤„ç†Unicodeè½¬ä¹‰åºåˆ—
    let decoded = textData.replace(/\\u([0-9a-fA-F]{4})/g, (match, code) => {
        return String.fromCharCode(parseInt(code, 16));
    });
    
    // å¤„ç†URLç¼–ç 
    try {
        decoded = decodeURIComponent(decoded);
    } catch (e) {
        console.warn(`å­—ç¬¦ç¼–ç å¤„ç†è­¦å‘Š: ${e.message}`);
    }
    
    return decoded;
}
```

### ğŸ› ï¸ æœ€ä½³å®è·µ

**1. é”™è¯¯å¤„ç†ç­–ç•¥**

```javascript
// åˆ†å±‚é”™è¯¯å¤„ç†
try {
    const data = await this.fetchDirectFromTencent(symbols);
    return this.processSuccessResponse(data);
} catch (networkError) {
    try {
        const data = await this.fetchViaBackend(symbols);
        return this.processBackendResponse(data);
    } catch (backendError) {
        const mockData = await this.generateMockData(symbols);
        return this.processMockResponse(mockData);
    }
}
```

**2. æ€§èƒ½ä¼˜åŒ–**

```javascript
// è¯·æ±‚å»é‡
const requestCache = new Map();

async fetchWithCache(symbols) {
    const cacheKey = symbols.sort().join(',');
    
    if (requestCache.has(cacheKey)) {
        const cached = requestCache.get(cacheKey);
        if (Date.now() - cached.timestamp < 5000) { // 5ç§’ç¼“å­˜
            return cached.data;
        }
    }
    
    const data = await this.fetchDirectFromTencent(symbols);
    requestCache.set(cacheKey, {
        data: data,
        timestamp: Date.now()
    });
    
    return data;
}
```

**3. æ•°æ®éªŒè¯**

```javascript
validateParsedData(data) {
    const errors = [];
    
    // å¿…å¡«å­—æ®µæ£€æŸ¥
    if (!data.symbol) errors.push('ç¼ºå°‘æŒ‡æ•°ä»£ç ');
    if (!data.name) errors.push('ç¼ºå°‘æŒ‡æ•°åç§°');
    if (typeof data.current_price !== 'number') errors.push('ä»·æ ¼æ ¼å¼é”™è¯¯');
    
    // æ•°å€¼èŒƒå›´æ£€æŸ¥
    if (data.current_price <= 0) errors.push('ä»·æ ¼å¿…é¡»å¤§äº0');
    if (Math.abs(data.change_percent) > 20) errors.push('æ¶¨è·Œå¹…å¼‚å¸¸');
    
    // æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
    const calculatedPercent = (data.change_points / (data.current_price - data.change_points)) * 100;
    if (Math.abs(calculatedPercent - data.change_percent) > 0.1) {
        errors.push('æ¶¨è·Œå¹…è®¡ç®—ä¸ä¸€è‡´');
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}
```

**4. ç›‘æ§å’Œå‘Šè­¦**

```javascript
// æ€§èƒ½ç›‘æ§
class PerformanceMonitor {
    constructor() {
        this.metrics = {
            requestCount: 0,
            successCount: 0,
            errorCount: 0,
            avgResponseTime: 0,
            lastError: null
        };
    }
    
    recordRequest(duration, success, error = null) {
        this.metrics.requestCount++;
        
        if (success) {
            this.metrics.successCount++;
        } else {
            this.metrics.errorCount++;
            this.metrics.lastError = error;
        }
        
        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        this.metrics.avgResponseTime = 
            (this.metrics.avgResponseTime * (this.metrics.requestCount - 1) + duration) / 
            this.metrics.requestCount;
    }
    
    getHealthStatus() {
        const successRate = this.metrics.successCount / this.metrics.requestCount;
        
        return {
            status: successRate > 0.95 ? 'healthy' : 'degraded',
            successRate: successRate,
            avgResponseTime: this.metrics.avgResponseTime,
            metrics: this.metrics
        };
    }
}
```

**5. å®‰å…¨è€ƒè™‘**

```javascript
// APIå¯†é’¥ç®¡ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
class SecureConfig {
    static getApiKey() {
        // ä»ç¯å¢ƒå˜é‡è·å–
        return process.env.TENCENT_API_KEY || '';
    }
    
    static sanitizeInput(input) {
        // è¾“å…¥éªŒè¯å’Œæ¸…ç†
        return input.replace(/[^a-zA-Z0-9]/g, '');
    }
    
    static validateSymbol(symbol) {
        // æŒ‡æ•°ä»£ç æ ¼å¼éªŒè¯
        const pattern = /^(sh|sz)\d{6}$/;
        return pattern.test(symbol);
    }
}
```

### ğŸ“‹ ç»´æŠ¤æ£€æŸ¥æ¸…å•

**æ—¥å¸¸ç»´æŠ¤ï¼š**
- [ ] æ£€æŸ¥APIè¿é€šæ€§çŠ¶æ€
- [ ] ç›‘æ§é”™è¯¯ç‡å’Œå“åº”æ—¶é—´
- [ ] éªŒè¯æ•°æ®å‡†ç¡®æ€§
- [ ] æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
- [ ] æ›´æ–°ä¾èµ–åŒ…ç‰ˆæœ¬

**å‘¨æœŸæ€§ç»´æŠ¤ï¼š**
- [ ] æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶
- [ ] æ›´æ–°æŒ‡æ•°åˆ—è¡¨é…ç½®
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å®‰å…¨æ¼æ´æ‰«æ
- [ ] å¤‡ä»½é…ç½®æ–‡ä»¶

**åº”æ€¥å“åº”ï¼š**
- [ ] å‡†å¤‡é™çº§æ–¹æ¡ˆ
- [ ] å»ºç«‹ç›‘æ§å‘Šè­¦
- [ ] åˆ¶å®šæ•…éšœæ¢å¤æµç¨‹
- [ ] å‡†å¤‡è”ç³»äººåˆ—è¡¨
- [ ] æ–‡æ¡£åŒ–æ•…éšœå¤„ç†æ­¥éª¤

---

## ğŸ“š é™„å½•

### ğŸ”— ç›¸å…³é“¾æ¥

- [è…¾è®¯è´¢ç»APIå®˜æ–¹æ–‡æ¡£](https://qt.gtimg.cn/)
- [é¡¹ç›®GitHubä»“åº“](https://github.com/your-repo/quantmind)
- [é—®é¢˜åé¦ˆ](https://github.com/your-repo/quantmind/issues)
- [æ›´æ–°æ—¥å¿—](https://github.com/your-repo/quantmind/releases)

### ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§[LICENSE](../LICENSE)æ–‡ä»¶ã€‚

### ğŸ‘¥ è´¡çŒ®è€…

æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ã€‚

### ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- é‚®ç®±ï¼šsupport@quantmind.com
- å¾®ä¿¡ç¾¤ï¼šQuantMindæŠ€æœ¯äº¤æµç¾¤
- QQç¾¤ï¼š123456789

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2024å¹´1æœˆ*
*æ–‡æ¡£ç‰ˆæœ¬ï¼šv2.0*